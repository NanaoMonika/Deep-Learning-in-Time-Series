
# Multiple Multistep Time Series Analysis

By Chuanyun (Clara) Zang 

The analysis aimed to solve a Kaggle competition problem – Web Traffic Time Series Forecasting. See https://www.kaggle.com/c/web-traffic-time-series-forecasting.

Long Short Term Memory network and some basic statistic method is used in the analysis. 

### Set up libraries


```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
%matplotlib inline

from sklearn.metrics import mean_squared_error
from sklearn.preprocessing import MinMaxScaler
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import LSTM
from keras.layers import Dropout
from keras.callbacks import ModelCheckpoint  

```

    Using TensorFlow backend.


### Import Datasets


```python
data = pd.read_csv('train_1.csv')
data.info()
data.head()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 145063 entries, 0 to 145062
    Columns: 551 entries, Page to 2016-12-31
    dtypes: float64(550), object(1)
    memory usage: 609.8+ MB





<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>2015-07-01</th>
      <th>2015-07-02</th>
      <th>2015-07-03</th>
      <th>2015-07-04</th>
      <th>2015-07-05</th>
      <th>2015-07-06</th>
      <th>2015-07-07</th>
      <th>2015-07-08</th>
      <th>2015-07-09</th>
      <th>...</th>
      <th>2016-12-22</th>
      <th>2016-12-23</th>
      <th>2016-12-24</th>
      <th>2016-12-25</th>
      <th>2016-12-26</th>
      <th>2016-12-27</th>
      <th>2016-12-28</th>
      <th>2016-12-29</th>
      <th>2016-12-30</th>
      <th>2016-12-31</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2NE1_zh.wikipedia.org_all-access_spider</td>
      <td>18.0</td>
      <td>11.0</td>
      <td>5.0</td>
      <td>13.0</td>
      <td>14.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>22.0</td>
      <td>26.0</td>
      <td>...</td>
      <td>32.0</td>
      <td>63.0</td>
      <td>15.0</td>
      <td>26.0</td>
      <td>14.0</td>
      <td>20.0</td>
      <td>22.0</td>
      <td>19.0</td>
      <td>18.0</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2PM_zh.wikipedia.org_all-access_spider</td>
      <td>11.0</td>
      <td>14.0</td>
      <td>15.0</td>
      <td>18.0</td>
      <td>11.0</td>
      <td>13.0</td>
      <td>22.0</td>
      <td>11.0</td>
      <td>10.0</td>
      <td>...</td>
      <td>17.0</td>
      <td>42.0</td>
      <td>28.0</td>
      <td>15.0</td>
      <td>9.0</td>
      <td>30.0</td>
      <td>52.0</td>
      <td>45.0</td>
      <td>26.0</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3C_zh.wikipedia.org_all-access_spider</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>...</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>6.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4minute_zh.wikipedia.org_all-access_spider</td>
      <td>35.0</td>
      <td>13.0</td>
      <td>10.0</td>
      <td>94.0</td>
      <td>4.0</td>
      <td>26.0</td>
      <td>14.0</td>
      <td>9.0</td>
      <td>11.0</td>
      <td>...</td>
      <td>32.0</td>
      <td>10.0</td>
      <td>26.0</td>
      <td>27.0</td>
      <td>16.0</td>
      <td>11.0</td>
      <td>17.0</td>
      <td>19.0</td>
      <td>10.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>52_Hz_I_Love_You_zh.wikipedia.org_all-access_s...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>48.0</td>
      <td>9.0</td>
      <td>25.0</td>
      <td>13.0</td>
      <td>3.0</td>
      <td>11.0</td>
      <td>27.0</td>
      <td>13.0</td>
      <td>36.0</td>
      <td>10.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 551 columns</p>
</div>




```python
key = pd.read_csv('key_1.csv')
key_split = key.copy()
key_split['date'] = key_split.Page.apply(lambda a: a[-10:])
key_split['Page'] = key_split.Page.apply(lambda a: a[:-11])
key_split.head()
```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>Id</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>bf4edcf969af</td>
      <td>2017-01-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>929ed2bf52b9</td>
      <td>2017-01-02</td>
    </tr>
    <tr>
      <th>2</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>ff29d0f51d5c</td>
      <td>2017-01-03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>e98873359be6</td>
      <td>2017-01-04</td>
    </tr>
    <tr>
      <th>4</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>fa012434263a</td>
      <td>2017-01-05</td>
    </tr>
  </tbody>
</table>
</div>



### Define metric functions


```python
from keras import backend as K

def smape(y_true, y_pred):
    diff = K.abs((y_true - y_pred) / K.clip(K.abs(y_true)+K.abs(y_pred),
                                            K.epsilon(),
                                            None))
    return 200. * K.mean(diff, axis=-1)

def smape_test(y_true, y_pred):
    denominator = (y_true+y_pred)/200.0
    diff = np.abs(y_true-y_pred)/denominator
    diff[denominator==0] = 0.0
    return np.mean(diff)
```

## Exploratory Analysis


```python
data0 = data.copy()
data0.iloc[:,1:].isnull().sum(axis=0).describe()
```


```python
data0 = data0.fillna(0)
```


```python
days = range(550)
def plot_entry(idx):
    data_temp = data0.iloc[idx,1:]
    fig = plt.figure(1,figsize=(6,4))
    plt.plot(days,data_temp)
    plt.xlabel('day')
    plt.ylabel('views')
    plt.title(data0.iloc[idx,0])
    
    plt.show()
```


```python
#for idx in [0, 5, 10000, 50000]:
for idx in [0, 50000]:
    print(idx)
    print(data0.iloc[idx,0])
    plot_entry(idx)    
```

    0
    2NE1_zh.wikipedia.org_all-access_spider



![png](output_12_1.png)


    50000
    Suicide_Squad_(Film)_de.wikipedia.org_all-access_spider



![png](output_12_3.png)


## Preprocess Data

#### Save true values for checking model performence later


```python
data = data.fillna(0)
#X_train = data[data.columns[1:-120]]
y_train_true = data[list(data.columns[-120:-60])]
#X_validate = data1[list(data1.columns[61:-60])]
y_validate_true = data[list(data.columns[-60:])]
#X_test = data1[list(data1.columns[121:])]
```

#### Work on a copy of the training data


```python
data1 = data.copy()

data1['index1'] = data1.index
data1 = data1[['index1']+list(data1.columns)[1:-1]]
#data1.head(1)
```

#### Transform all values in dataset by using natural logarithm


```python
### Take log(x+1)
data1[data1.columns[1:]] = data1[data1.columns[1:]].apply(lambda x: np.log(x+1))
#data1.head(1)
```

#### Define X_train, y_train, X_test, y_test


```python
X_train = data1[data1.columns[1:-120]]
y_train = data1[list(data1.columns[-120:-60])]
X_validate = data1[list(data1.columns[61:-60])]
y_validate = data1[list(data1.columns[-60:])]
X_test = data1[list(data1.columns[121:])]
```

#### Normalize X_train/validate/test


```python
### Normalization X so that visits in each day are in the same range
## ? yes

#range_train = (X_train.max()-X_train.min()).replace('0', '1').astype('float64')
X_train_norm = (X_train - X_train.min())/(X_train.max()-X_train.min())
#y_train_norm = (y_train - y_train.mean())/y_train.std()
#X_validate_norm = (X_validate.max()-X_validate.min()).replace('0', '1').astype('float64')
X_validate_norm = (X_validate - X_validate.min())/(X_validate.max()-X_validate.min())

X_test_norm = (X_test - X_test.min())/(X_test.max()-X_test.min())

print('X_train_norm: ', X_train_norm.shape)
print('y_validate: ', y_validate.shape)
```

    ('X_train_norm: ', (145063, 430))
    ('y_validate: ', (145063, 60))


#### Reshape datasets for LSTM model


```python
## reshape after normalized
X_train1 = X_train_norm.values.reshape(X_train.shape[0], 1, X_train.shape[1])
X_validate1 = X_validate_norm.values.reshape(X_validate.shape[0], 1, X_validate.shape[1])
y_train1 = y_train.values
y_validate1 = y_validate.values

X_test1 = X_test_norm.values.reshape(X_test.shape[0], 1, X_test.shape[1])

```

## Build Models

### Define model and train on X_train, y_train and validate on X_validate, y_validate


```python
LSTM_model = Sequential()
LSTM_model.add(LSTM(256, input_shape = (1,X_train.shape[1])))
LSTM_model.add(Dropout(0.3))
LSTM_model.add(Dense(60))
LSTM_model.compile(loss = 'mean_absolute_error', optimizer = 'rmsprop')
#LSTM_model.compile(loss = smape, optimizer = 'rmsprop')

LSTM_model.summary()
```

    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    lstm_1 (LSTM)                (None, 256)               703488    
    _________________________________________________________________
    dropout_1 (Dropout)          (None, 256)               0         
    _________________________________________________________________
    dense_1 (Dense)              (None, 60)                15420     
    =================================================================
    Total params: 718,908
    Trainable params: 718,908
    Non-trainable params: 0
    _________________________________________________________________



```python
from IPython.display import SVG
from keras.utils.vis_utils import model_to_dot

SVG(model_to_dot(LSTM_model).create(prog='dot', format='svg'))
```




![svg](output_29_0.svg)




```python
epochs = 10
checkpointer = ModelCheckpoint(filepath='weights.best.from_scratch1.hdf5', verbose=1, save_best_only=True)
print('Start training...')

LSTM_model.fit(X_train1, y_train1, validation_data=(X_validate1, y_validate1), 
              epochs=epochs, callbacks=[checkpointer], verbose=1)
#LSTM_model.fit(X_train1, y_train1, validation_split=0.05, 
#               epochs=epochs, callbacks=[checkpointer], verbose=1)
```

    Start training...
    Train on 145063 samples, validate on 145063 samples
    Epoch 1/10
    145056/145063 [============================>.] - ETA: 0s - loss: 0.6299   Epoch 00000: val_loss improved from inf to 0.54336, saving model to weights.best.from_scratch1.hdf5
    145063/145063 [==============================] - 77s - loss: 0.6299 - val_loss: 0.5434
    Epoch 2/10
    144960/145063 [============================>.] - ETA: 0s - loss: 0.5731  - ETA: 80s - loss: 0.5854Epoch 00001: val_loss did not improve
    145063/145063 [==============================] - 77s - loss: 0.5731 - val_loss: 0.6049
    Epoch 3/10
    145056/145063 [============================>.] - ETA: 0s - loss: 0.5600  Epoch 00002: val_loss did not improve
    145063/145063 [==============================] - 77s - loss: 0.5600 - val_loss: 0.6102
    Epoch 4/10
    144992/145063 [============================>.] - ETA: 0s - loss: 0.5518 Epoch 00003: val_loss improved from 0.54336 to 0.50532, saving model to weights.best.from_scratch1.hdf5
    145063/145063 [==============================] - 80s - loss: 0.5518 - val_loss: 0.5053
    Epoch 5/10
    144960/145063 [============================>.] - ETA: 0s - loss: 0.5437  Epoch 00004: val_loss did not improve
    145063/145063 [==============================] - 80s - loss: 0.5437 - val_loss: 0.5800
    Epoch 6/10
    144992/145063 [============================>.] - ETA: 0s - loss: 0.5384  Epoch 00005: val_loss did not improve
    145063/145063 [==============================] - 81s - loss: 0.5384 - val_loss: 0.5148
    Epoch 7/10
    145056/145063 [============================>.] - ETA: 0s - loss: 0.5352 Epoch 00006: val_loss did not improve
    145063/145063 [==============================] - 81s - loss: 0.5352 - val_loss: 0.5108
    Epoch 8/10
    144992/145063 [============================>.] - ETA: 0s - loss: 0.5301 Epoch 00007: val_loss did not improve
    145063/145063 [==============================] - 81s - loss: 0.5301 - val_loss: 0.5069
    Epoch 9/10
    145024/145063 [============================>.] - ETA: 0s - loss: 0.5252 Epoch 00008: val_loss improved from 0.50532 to 0.48786, saving model to weights.best.from_scratch1.hdf5
    145063/145063 [==============================] - 80s - loss: 0.5252 - val_loss: 0.4879
    Epoch 10/10
    144992/145063 [============================>.] - ETA: 0s - loss: 0.5238 Epoch 00009: val_loss did not improve
    145063/145063 [==============================] - 84s - loss: 0.5238 - val_loss: 0.5765





    <keras.callbacks.History at 0x368091590>



#### Check the model performance by using SMAPE


```python
LSTM_model.load_weights('weights.best.from_scratch1.hdf5')

########## Validate model 
y_validate_pred = LSTM_model.predict(X_validate1)
#comment for LSTM
#y_validate_pred = y_validate_pred.reshape(y_validate_pred.shape[0], y_validate_pred.shape[2])
y_validate_pred1 = pd.DataFrame(data = y_validate_pred, columns = list(y_validate.columns))

##inverse to counts of visits
y_val_pred = y_validate_pred1.apply(lambda x: np.exp(x)-1)

for i in list(y_val_pred.columns):
    y_val_pred[i] = y_val_pred[i].apply(lambda x: round(x))

y_val_pred[y_val_pred<0]=0

print('SAMPE of validate set when training on X_train: ', smape_test(y_validate_true.stack(), y_val_pred.stack()))

##LSTM 46.39/ 45.5
```

    ('SAMPE of validate set when training on X_train: ', 45.944525720974546)


#### The benchmark model


```python
## benckmark: median of previous 60 days
y_train_true1 = y_train.copy()
y_train_true1['V'] = y_train_true.median(axis=1)
y_train_true1.head()

for i in list(y_validate_true.columns):
    y_train_true1[i] = y_train_true1['V']

smape_test(y_validate_true.stack(), y_train_true1[y_train_true1.columns[-60:]].stack())
```




    47.96375802400474



#### Predict on X_test, and save output by Page and date


```python
## to get 'Page'
X_test_P = data[['Page']+list(data.columns[-7:])]
```


```python
######## Predict
LSTM_model.load_weights('weights.best.from_scratch1.hdf5')

y_test_pred = LSTM_model.predict(X_test1)

out_cols = list(pd.unique(key_split['date'].values))
y_test_pred1 = pd.DataFrame(data = y_test_pred, columns = list(out_cols))

##Inverse if outlier removed
y_test_pred2 = y_test_pred1.apply(lambda x: np.exp(x)-1)

y_test_pred2[y_test_pred2<0] =0

###merge into Page
test_out = pd.merge(X_test_P, y_test_pred2, left_index = True, right_index = True)
test_out1 = test_out[['Page']+list(test_out.columns.values[-60:])]
test_out_120D = pd.melt(test_out1, id_vars='Page', var_name='date', value_name='Visits_120D')
test_out_120D.head()
#results_120D = key_split.merge(test_out2, how ='left')

```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>date</th>
      <th>Visits_120D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2NE1_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>20.370663</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2PM_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>23.933784</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3C_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>5.920140</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4minute_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>15.802696</td>
    </tr>
    <tr>
      <th>4</th>
      <td>52_Hz_I_Love_You_zh.wikipedia.org_all-access_s...</td>
      <td>2017-01-01</td>
      <td>15.828934</td>
    </tr>
  </tbody>
</table>
</div>



### Retrian model on X_validate, y_validate


```python
checkpointer = ModelCheckpoint(filepath='weights.best.from_scratch2.hdf5', verbose=1, save_best_only=True)
print('Start training...')
LSTM_model.fit(X_validate1, y_validate1, validation_split = 0.05, 
               epochs=epochs, callbacks=[checkpointer], verbose=1)
```

    Start training...
    Train on 137809 samples, validate on 7254 samples
    Epoch 1/10
    137760/137809 [============================>.] - ETA: 0s - loss: 0.5212 Epoch 00000: val_loss improved from inf to 0.50509, saving model to weights.best.from_scratch2.hdf5
    137809/137809 [==============================] - 68s - loss: 0.5213 - val_loss: 0.5051
    Epoch 2/10
    137792/137809 [============================>.] - ETA: 0s - loss: 0.5170  Epoch 00001: val_loss did not improve
    137809/137809 [==============================] - 73s - loss: 0.5170 - val_loss: 0.5280
    Epoch 3/10
    137792/137809 [============================>.] - ETA: 0s - loss: 0.5135  - ETA: 29s - loss: 0.5139Epoch 00002: val_loss did not improve
    137809/137809 [==============================] - 71s - loss: 0.5135 - val_loss: 0.5415
    Epoch 4/10
    137728/137809 [============================>.] - ETA: 0s - loss: 0.5106  Epoch 00003: val_loss improved from 0.50509 to 0.48590, saving model to weights.best.from_scratch2.hdf5
    137809/137809 [==============================] - 68s - loss: 0.5106 - val_loss: 0.4859
    Epoch 5/10
    137696/137809 [============================>.] - ETA: 0s - loss: 0.5070 Epoch 00004: val_loss did not improve
    137809/137809 [==============================] - 69s - loss: 0.5070 - val_loss: 0.5108
    Epoch 6/10
    137728/137809 [============================>.] - ETA: 0s - loss: 0.5047 Epoch 00005: val_loss improved from 0.48590 to 0.48088, saving model to weights.best.from_scratch2.hdf5
    137809/137809 [==============================] - 72s - loss: 0.5047 - val_loss: 0.4809
    Epoch 7/10
    137792/137809 [============================>.] - ETA: 0s - loss: 0.5034  Epoch 00006: val_loss did not improve
    137809/137809 [==============================] - 68s - loss: 0.5034 - val_loss: 0.5041
    Epoch 8/10
    137696/137809 [============================>.] - ETA: 0s - loss: 0.5006 Epoch 00007: val_loss did not improve
    137809/137809 [==============================] - 67s - loss: 0.5006 - val_loss: 0.4897
    Epoch 9/10
    137696/137809 [============================>.] - ETA: 0s - loss: 0.4983 Epoch 00008: val_loss did not improve
    137809/137809 [==============================] - 68s - loss: 0.4983 - val_loss: 0.5156
    Epoch 10/10
    137760/137809 [============================>.] - ETA: 0s - loss: 0.4965 Epoch 00009: val_loss did not improve
    137809/137809 [==============================] - 66s - loss: 0.4965 - val_loss: 0.5177





    <keras.callbacks.History at 0x230cd7a50>




```python
LSTM_model.load_weights('weights.best.from_scratch2.hdf5')

### check model on training data
y_train_pred = LSTM_model.predict(X_train1)
y_train_pred1 = pd.DataFrame(data = y_train_pred, columns = list(y_train.columns))

y_train_pred = y_train_pred1.apply(lambda x: np.exp(x)-1)


for i in list(y_train_pred.columns):
    y_train_pred[i] = y_train_pred[i].apply(lambda x: round(x))

y_train_pred[y_train_pred<0]=0

print('SAMPE of train set when training on X_validate: ', smape_test(y_train_true.stack(),y_train_pred.stack()))
#45.52858730028269
```

    ('SAMPE of train set when training on X_validate: ', 45.38421268962829)



```python
######## Predict
LSTM_model.load_weights('weights.best.from_scratch2.hdf5')

y_test_pred = LSTM_model.predict(X_test1)

out_cols = list(pd.unique(key_split['date'].values))
y_test_pred1 = pd.DataFrame(data = y_test_pred, columns = list(out_cols))

##Inverse if outlier removed
y_test_pred2 = y_test_pred1.apply(lambda x: np.exp(x)-1)

y_test_pred2[y_test_pred2<0] =0

###merge into Page
test_out = pd.merge(X_test_P, y_test_pred2, left_index = True, right_index = True)
test_out1 = test_out[['Page']+list(test_out.columns.values[-60:])]
test_out_60D = pd.melt(test_out1, id_vars='Page', var_name='date', value_name='Visits_60D')
test_out_60D.head()
#results_60D = key_split.merge(test_out2, how ='left')
```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>date</th>
      <th>Visits_60D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2NE1_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>20.829733</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2PM_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>23.671522</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3C_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>4.940643</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4minute_zh.wikipedia.org_all-access_spider</td>
      <td>2017-01-01</td>
      <td>16.406521</td>
    </tr>
    <tr>
      <th>4</th>
      <td>52_Hz_I_Love_You_zh.wikipedia.org_all-access_s...</td>
      <td>2017-01-01</td>
      <td>14.735157</td>
    </tr>
  </tbody>
</table>
</div>



### Combine results from two models


```python
#### Combine two model results
results = test_out_120D.merge(test_out_60D)
results['Visits_Seq'] = results[['Visits_120D', 'Visits_60D']].mean(axis =1).apply(lambda x: round(x))

## Merge on 'Page' and 'date'
key_rnn_result = key_split.merge(results, how ='left')
key_rnn_result.head()
```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>Id</th>
      <th>date</th>
      <th>Visits_120D</th>
      <th>Visits_60D</th>
      <th>Visits_Seq</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>bf4edcf969af</td>
      <td>2017-01-01</td>
      <td>2.757196</td>
      <td>2.864099</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>929ed2bf52b9</td>
      <td>2017-01-02</td>
      <td>2.375104</td>
      <td>2.431506</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>ff29d0f51d5c</td>
      <td>2017-01-03</td>
      <td>2.382111</td>
      <td>2.420799</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>e98873359be6</td>
      <td>2017-01-04</td>
      <td>2.700510</td>
      <td>2.568208</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>fa012434263a</td>
      <td>2017-01-05</td>
      <td>2.815577</td>
      <td>2.485751</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
rnn_results = key_rnn_result[['Id','Visits_Seq']]
```

## Median of Medians

We can use a simple loop here.


```python
##### last week, daily
train_bench = data[['Page'] + list(data.columns[-7:])]
train_bench['last_Visits'] = train_bench[list(train_bench.columns[-7:])].median(axis=1)
train_bench_last_week = train_bench[['Page', 'last_Visits']]

results1 = key_split.merge(train_bench_last_week, how = 'left')

results1['date'] = results1['date'].astype('datetime64[ns]')
results1['weekday'] = (results1.date.dt.dayofweek).astype(float) 
results1.tail()

##### Previous 3 weeks, DayofWeek
train_bench_3week = data[['Page'] + list(data.columns[-21:])]
train_3week_flattened = pd.melt(train_bench_3week, id_vars='Page', var_name='date', value_name='Visits_3week')
train_3week_flattened['date'] = train_3week_flattened['date'].astype('datetime64[ns]')
train_3week_flattened['weekday'] = (train_3week_flattened.date.dt.dayofweek).astype(float)
train_3week_m = train_3week_flattened.groupby(['Page','weekday']).median().reset_index()
train_3week_m['L3week_Visits'] = train_3week_m.Visits_3week
#print(train_3week_m.head())
train_bench_3week = train_3week_m[['Page',  'weekday', 'L3week_Visits']]
train_bench_3week.tail()

train_bench_3week['Page'].tail(1)


results2 = results1.merge(train_bench_3week, how = 'left')
results2.tail()

### previous 9 weeks which are more than 2 months
train_bench_9week = data[['Page'] + list(data.columns[-63:])]
train_9week_flattened = pd.melt(train_bench_9week, id_vars='Page', var_name='date', value_name='Visits_9week')
train_9week_flattened['date'] = train_9week_flattened['date'].astype('datetime64[ns]')
train_9week_flattened['weekday'] = (train_9week_flattened.date.dt.dayofweek).astype(float)
train_9week_m = train_9week_flattened.groupby(['Page','weekday']).median().reset_index()
train_9week_m['L9week_Visits'] = train_9week_m.Visits_9week
#print(train_9week_m.head())
train_bench_9week = train_9week_m[['Page',  'weekday', 'L9week_Visits']]
train_bench_9week.tail()

results4 = results2.merge(train_bench_9week, how = 'left')
results4.tail()


#### last year, 2016
train_bench_year = data[['Page'] + list(data.columns[-365:])]
train_year_flattened = pd.melt(train_bench_year, id_vars='Page', var_name='date', value_name='Visits_year')
train_year_flattened['date'] = train_year_flattened['date'].astype('datetime64[ns]')
train_year_flattened['weekday'] = (train_year_flattened.date.dt.dayofweek).astype(float)
train_year_m = train_year_flattened.groupby(['Page','weekday']).median().reset_index()
train_year_m['year_Visits'] = train_year_m.Visits_year
#print(train_year_m.head())
train_bench_year = train_year_m[['Page',  'weekday', 'year_Visits']]
#print(train_bench_year.tail())


results6 = results4.merge(train_bench_year, how = 'left')
results6.tail()


### same month in previous years
train_bench_month = data[['Page', '2016-01-01', '2016-01-02', '2016-01-03', '2016-01-04',
       '2016-01-05', '2016-01-06', '2016-01-07', '2016-01-08',
       '2016-01-09', '2016-01-10', '2016-01-11', '2016-01-12',
       '2016-01-13', '2016-01-14', '2016-01-15', '2016-01-16',
       '2016-01-17', '2016-01-18', '2016-01-19', '2016-01-20',
       '2016-01-21', '2016-01-22', '2016-01-23', '2016-01-24',
       '2016-01-25', '2016-01-26', '2016-01-27', '2016-01-28',
       '2016-01-29', '2016-01-30', '2016-01-31', '2016-02-01',
       '2016-02-02', '2016-02-03', '2016-02-04', '2016-02-05',
       '2016-02-06', '2016-02-07', '2016-02-08', '2016-02-09',
       '2016-02-10', '2016-02-11', '2016-02-12', '2016-02-13',
       '2016-02-14', '2016-02-15', '2016-02-16', '2016-02-17',
       '2016-02-18', '2016-02-19', '2016-02-20', '2016-02-21',
       '2016-02-22', '2016-02-23', '2016-02-24', '2016-02-25',
       '2016-02-26', '2016-02-27', '2016-02-28', '2016-02-29',
       '2016-03-01']]
train_month_flattened = pd.melt(train_bench_month, id_vars='Page', var_name='date', value_name='Visits_month')
train_month_flattened['date'] = train_month_flattened['date'].astype('datetime64[ns]')
train_month_flattened['weekday'] = (train_month_flattened.date.dt.dayofweek).astype(float)
train_month_m = train_month_flattened.groupby(['Page','weekday']).median().reset_index()
train_month_m['Month_Visits'] = train_month_m.Visits_month
#print(train_month_m.head())
train_bench_month = train_month_m[['Page',  'weekday', 'Month_Visits']]
train_bench_month.head()


results7 = results6.merge(train_bench_month, how = 'left')
results7.tail()

```

    /Users/cz692t/anaconda2/lib/python2.7/site-packages/ipykernel/__main__.py:3: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
      app.launch_new_instance()





<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>Id</th>
      <th>date</th>
      <th>last_Visits</th>
      <th>weekday</th>
      <th>L3week_Visits</th>
      <th>L9week_Visits</th>
      <th>year_Visits</th>
      <th>Month_Visits</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8703775</th>
      <td>龙生九子_zh.wikipedia.org_mobile-web_all-agents</td>
      <td>f69747f5ee68</td>
      <td>2017-02-25</td>
      <td>339.0</td>
      <td>5.0</td>
      <td>309.0</td>
      <td>233.0</td>
      <td>150.0</td>
      <td>142.0</td>
    </tr>
    <tr>
      <th>8703776</th>
      <td>龙生九子_zh.wikipedia.org_mobile-web_all-agents</td>
      <td>2489963dc503</td>
      <td>2017-02-26</td>
      <td>339.0</td>
      <td>6.0</td>
      <td>339.0</td>
      <td>246.0</td>
      <td>157.5</td>
      <td>144.0</td>
    </tr>
    <tr>
      <th>8703777</th>
      <td>龙生九子_zh.wikipedia.org_mobile-web_all-agents</td>
      <td>b0624c909f4c</td>
      <td>2017-02-27</td>
      <td>339.0</td>
      <td>0.0</td>
      <td>302.0</td>
      <td>217.0</td>
      <td>132.0</td>
      <td>136.0</td>
    </tr>
    <tr>
      <th>8703778</th>
      <td>龙生九子_zh.wikipedia.org_mobile-web_all-agents</td>
      <td>24a1dfb06c10</td>
      <td>2017-02-28</td>
      <td>339.0</td>
      <td>1.0</td>
      <td>302.0</td>
      <td>198.0</td>
      <td>122.5</td>
      <td>123.0</td>
    </tr>
    <tr>
      <th>8703779</th>
      <td>龙生九子_zh.wikipedia.org_mobile-web_all-agents</td>
      <td>add681d54216</td>
      <td>2017-03-01</td>
      <td>339.0</td>
      <td>2.0</td>
      <td>283.0</td>
      <td>214.0</td>
      <td>123.5</td>
      <td>121.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
#### run if you want to check EDA results
results7['Visits_M'] = results7[['last_Visits', 'L3week_Visits', 'L9week_Visits', 'year_Visits', 'Month_Visits']].median(axis =1).apply(lambda x: round(x))

```

## Combine RNN and EDA results


```python
final_results = rnn_results.merge(results7, how = 'left')
final_results['Visits'] = final_results[['Visits_Seq', 'last_Visits', 'L3week_Visits', 'L9week_Visits', 'year_Visits', 'Month_Visits']].median(axis =1).apply(lambda x: round(x))
#final_results[['Id','Visits']].to_csv('results_RNN_EDA.csv', index=False)

```

## Check Performance


```python
anwer_key = pd.read_csv("answer_key_1_0.csv")
anwer_key.head(3)
```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>Visits</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bf4edcf969af</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>929ed2bf52b9</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ff29d0f51d5c</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
### benckmark by using the median of views in the last 60 days
bench = data[['Page'] + list(data.columns[-60:])]
bench['last_Visits'] = bench[list(bench.columns[-60:])].median(axis=1)
benchmark = bench[['Page', 'last_Visits']]

results0 = key_split.merge(benchmark, how = 'left')
smape_test(anwer_key['Visits'], results0['last_Visits'])
```

    /Users/cz692t/anaconda2/lib/python2.7/site-packages/ipykernel/__main__.py:3: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
      app.launch_new_instance()





    46.510111921825725




```python
#L9week_Visits
smape_test(anwer_key['Visits'], results7['L9week_Visits'])
```




    46.70122162330847




```python
smape_test(anwer_key['Visits'], rnn_results['Visits_Seq'])
### 45.97 when validate_split
### 45.89
```




    45.896923710764995




```python
smape_test(anwer_key['Visits'], results7['Visits_M'])
```




    44.289874695264906




```python
smape_test(anwer_key['Visits'], final_results['Visits'])
### The best!!
```




    43.590704586850855




```python
smape_test(anwer_key['Visits'], key_rnn_result['Visits_60D'].apply(lambda x:round(x)))
```




    46.15077999144785




```python
smape_test(anwer_key['Visits'], key_rnn_result['Visits_120D'].apply(lambda x:round(x)))
```




    46.86666187821527



## Visualize final results


```python
pred_result = final_results[['Page', 'date', 'Visits']]
pred_result.head()
```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>date</th>
      <th>Visits</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>2017-01-01</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>2017-01-02</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>2017-01-03</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>2017-01-04</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>!vote_en.wikipedia.org_all-access_all-agents</td>
      <td>2017-01-05</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
### data set including the true y_test
data2 = pd.read_csv('stage_2/train_2.csv')
data2.head(3)
```




<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Page</th>
      <th>2015-07-01</th>
      <th>2015-07-02</th>
      <th>2015-07-03</th>
      <th>2015-07-04</th>
      <th>2015-07-05</th>
      <th>2015-07-06</th>
      <th>2015-07-07</th>
      <th>2015-07-08</th>
      <th>2015-07-09</th>
      <th>...</th>
      <th>2017-09-01</th>
      <th>2017-09-02</th>
      <th>2017-09-03</th>
      <th>2017-09-04</th>
      <th>2017-09-05</th>
      <th>2017-09-06</th>
      <th>2017-09-07</th>
      <th>2017-09-08</th>
      <th>2017-09-09</th>
      <th>2017-09-10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2NE1_zh.wikipedia.org_all-access_spider</td>
      <td>18.0</td>
      <td>11.0</td>
      <td>5.0</td>
      <td>13.0</td>
      <td>14.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>22.0</td>
      <td>26.0</td>
      <td>...</td>
      <td>19.0</td>
      <td>33.0</td>
      <td>33.0</td>
      <td>18.0</td>
      <td>16.0</td>
      <td>27.0</td>
      <td>29.0</td>
      <td>23.0</td>
      <td>54.0</td>
      <td>38.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2PM_zh.wikipedia.org_all-access_spider</td>
      <td>11.0</td>
      <td>14.0</td>
      <td>15.0</td>
      <td>18.0</td>
      <td>11.0</td>
      <td>13.0</td>
      <td>22.0</td>
      <td>11.0</td>
      <td>10.0</td>
      <td>...</td>
      <td>32.0</td>
      <td>30.0</td>
      <td>11.0</td>
      <td>19.0</td>
      <td>54.0</td>
      <td>25.0</td>
      <td>26.0</td>
      <td>23.0</td>
      <td>13.0</td>
      <td>81.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3C_zh.wikipedia.org_all-access_spider</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>...</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>7.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>7.0</td>
      <td>6.0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 804 columns</p>
</div>




```python
data2 = data2.fillna(0)
```


```python
benchmark.head()
for i in ['Visits' + str(i) for i in range(60)]:
    benchmark[i] = benchmark['last_Visits']
```

    /Users/cz692t/anaconda2/lib/python2.7/site-packages/ipykernel/__main__.py:3: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
      app.launch_new_instance()



```python
days1 = range(500,610)
days2 = range(550,610)
def plot_pred1(idx):
    fig = plt.figure(1,figsize=(10,6))
    print(data2.iloc[idx,0])
    plt.plot(days1,data2.iloc[idx,1+500:611], label = 'true y_test')
    plt.plot(days2, benchmark.iloc[idx,-60:], label = 'benchmark')
    pred_V = pred_result[pred_result.Page==data2.iloc[idx,0]].Visits
    plt.plot(days2, pred_V, label = 'final model')    
    pred_LSTM = final_results[final_results.Page==data2.iloc[idx,0]].Visits_Seq
    plt.plot(days2, pred_LSTM, label = 'LSTM')
    pred_M = results7[results7.Page==data2.iloc[idx,0]].Visits_M
    plt.plot(days2, pred_M, label = 'Median of Medians')    
    plt.xlabel('day')
    plt.ylabel('views')
    #plt.title(data2.iloc[idx,0])
    plt.legend()
    plt.show()
```


```python
for idx in [5000,10000,18000]:
    plot_pred1(idx)
```

    Guadeloupe_fr.wikipedia.org_desktop_all-agents



![png](output_65_1.png)


    Ohi_Day_en.wikipedia.org_desktop_all-agents



![png](output_65_3.png)


    Блэк,_Джек_ru.wikipedia.org_mobile-web_all-agents



![png](output_65_5.png)



```python

```
